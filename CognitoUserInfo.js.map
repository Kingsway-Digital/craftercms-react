{"version":3,"sources":["src/CognitoUserInfo.js"],"names":["CognitoLoginCallback","props","ensureConfigured","user","update","onSuccessInclude","onFailureInclude","onLoadInclude","cognitoSession","setCognitoSession","loading","setLoading","parseCognitoCallbackUrl","window","location","href","then","session","appUser","asAppUser","idToken","jwtToken","e","console","error","CognitoLogoutCallback","setError","CognitoUserRequired","children","fallback","isLoggedIn","setIsLoggedIn","getAppUser","cu","configuration","getCognitoSignInUri","getConfig","url","scopes","appClientId","base","callbackPath","getCognitoSignUpUri","getCognitoSignOutUri","signoutPath","isConfigured","Error","windowUrlParts","split","createCognitoAuth","appWebDomain","replace","auth","CognitoAuth","UserPoolId","userPoolId","ClientId","AppWebDomain","TokenScopesArray","RedirectUriSignIn","RedirectUriSignOut","createCognitoUser","pool","CognitoUserPool","getCurrentUser","fullCallbackUrl","Promise","resolve","reject","userhandler","onSuccess","onFailure","parseCognitoWebResponse","cognitoUser","getSession","poolUrl","credentials","CognitoIdentityCredentials","Logins","prop","payload"],"mappings":";;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAIA;;;;;;;;;;;;;;;;;;;;AAEO,SAASA,oBAAT,CAA8BC,KAA9B,EAAqC;AAC1CC,EAAAA,gBAAgB;;AAChB,0BAA2B,sCAA3B;AAAA;AAAA,MAASC,IAAT,yBAASA,IAAT;AAAA,MAAiBC,MAAjB;;AACA,MAAQC,gBAAR,GAA8DJ,KAA9D,CAAQI,gBAAR;AAAA,MAA0BC,gBAA1B,GAA8DL,KAA9D,CAA0BK,gBAA1B;AAAA,MAA4CC,aAA5C,GAA8DN,KAA9D,CAA4CM,aAA5C;;AACA,kBAA4C,qBAAS,IAAT,CAA5C;AAAA;AAAA,MAAOC,cAAP;AAAA,MAAuBC,iBAAvB;;AACA,mBAA8B,qBAAS,KAAT,CAA9B;AAAA;AAAA,MAAOC,OAAP;AAAA,MAAgBC,UAAhB;;AAEA,wBAAU,YAAM;AACd,QAAI,CAACR,IAAL,EAAW;AACTQ,MAAAA,UAAU,CAAC,IAAD,CAAV;AACAC,MAAAA,uBAAuB,CAACC,MAAM,CAACC,QAAP,CAAgBC,IAAjB,CAAvB,CACGC,IADH,CACQ,UAACC,OAAD,EAAa;AACjB;AACAR,QAAAA,iBAAiB,CAACQ,OAAD,CAAjB;AACA,YAAMC,OAAO,GAAGC,SAAS,CAACF,OAAD,CAAzB;AACAb,QAAAA,MAAM,CAAC;AAAED,UAAAA,IAAI,EAAEe;AAAR,SAAD,CAAN;AACA,gDAA8BD,OAAO,CAACG,OAAR,CAAgBC,QAA9C;AACAV,QAAAA,UAAU,CAAC,KAAD,CAAV;AACD,OARH,WASS,UAACW,CAAD,EAAO;AACZC,QAAAA,OAAO,CAACC,KAAR,CAAc,8BAAd,EAA8CF,CAA9C;AACAX,QAAAA,UAAU,CAAC,KAAD,CAAV;AACD,OAZH;AAaD;AACF,GAjBD,EAiBG,EAjBH;;AAmBA,MAAID,OAAJ,EAAa;AACX,WAAOH,aAAa,GAAGA,aAAH,GAAmB,IAAvC;AACD,GAFD,MAEO;AACL,QAAIC,cAAJ,EAAoB;AAClB,aAAOH,gBAAgB,GAAGA,gBAAH,GAAsB,IAA7C;AACD,KAFD,MAEO;AACL,aAAOC,gBAAgB,GAAGA,gBAAH,GAAsB,IAA7C;AACD;AACF;AACF;;AAEM,SAASmB,qBAAT,CAA+BxB,KAA/B,EAAsC;AAC3CC,EAAAA,gBAAgB;;AAChB,2BAA2B,sCAA3B;AAAA;AAAA,MAASC,IAAT,yBAASA,IAAT;AAAA,MAAiBC,MAAjB;;AACA,MAAQC,gBAAR,GAA8DJ,KAA9D,CAAQI,gBAAR;AAAA,MAA0BC,gBAA1B,GAA8DL,KAA9D,CAA0BK,gBAA1B;AAAA,MAA4CC,aAA5C,GAA8DN,KAA9D,CAA4CM,aAA5C;;AACA,mBAA8B,qBAAS,KAAT,CAA9B;AAAA;AAAA,MAAOG,OAAP;AAAA,MAAgBC,UAAhB;;AACA,mBAA0B,qBAAS,IAAT,CAA1B;AAAA;AAAA,MAAOa,KAAP;AAAA,MAAcE,QAAd;;AAEA,wBAAU,YAAM;AACdf,IAAAA,UAAU,CAAC,IAAD,CAAV;AACA;AACAP,IAAAA,MAAM,CAAC;AAAED,MAAAA,IAAI,EAAE;AAAR,KAAD,CAAN;AACAQ,IAAAA,UAAU,CAAC,KAAD,CAAV;AACD,GALD,EAKG,CAACR,IAAD,EAAOO,OAAP,CALH;;AAOA,MAAIA,OAAJ,EAAa;AACX,WAAOH,aAAa,GAAGA,aAAH,GAAmB,IAAvC;AACD,GAFD,MAEO;AACL,QAAIiB,KAAJ,EAAW;AACTD,MAAAA,OAAO,CAACC,KAAR,CAAc,kCAAd,EAAkDA,KAAlD;AACA,aAAOlB,gBAAgB,GAAGA,gBAAH,GAAsB,IAA7C;AACD,KAHD,MAGO;AACL,aAAOD,gBAAgB,GAAGA,gBAAH,GAAsB,IAA7C;AACD;AACF;AACF;;AAEM,SAASsB,mBAAT,CAA6B1B,KAA7B,EAAoC;AACzCC,EAAAA,gBAAgB;AAChB,MAAQ0B,QAAR,GAA+B3B,KAA/B,CAAQ2B,QAAR;AAAA,MAAkBC,QAAlB,GAA+B5B,KAA/B,CAAkB4B,QAAlB;;AACA,mBAA4C,qBAAS,IAAT,CAA5C;AAAA;AAAA,MAAOrB,cAAP;AAAA,MAAuBC,iBAAvB;;AACA,2BAA2B,sCAA3B;AAAA;AAAA,MAASN,IAAT,yBAASA,IAAT;AAAA,MAAiBC,MAAjB;;AACA,oBAAoC,qBAAS,KAAT,CAApC;AAAA;AAAA,MAAO0B,UAAP;AAAA,MAAmBC,aAAnB;;AACA,wBAAU,YAAM;AACd,QAAI5B,IAAJ,EAAU;AACR4B,MAAAA,aAAa,CAAC,IAAD,CAAb;AACD,KAFD,MAEO;AACLC,MAAAA,UAAU,GACPhB,IADH,CACQ,UAACiB,EAAD,EAAQ;AACZ7B,QAAAA,MAAM,CAAC;AAAED,UAAAA,IAAI,EAAE8B;AAAR,SAAD,CAAN;AACA,gDAA8BhB,OAAO,CAACG,OAAR,CAAgBC,QAA9C;AACAU,QAAAA,aAAa,CAAC,IAAD,CAAb;AACD,OALH,WAMS,UAACT,CAAD,EAAO;AACZ;AACAS,QAAAA,aAAa,CAAC,KAAD,CAAb;AACD,OATH;AAUD;AACF,GAfD,EAeG,CAAC5B,IAAD,EAAO+B,4BAAP,CAfH;AAgBA,SAAOJ,UAAU,GAAGF,QAAH,GAAcC,QAA/B;AACD;;AAEM,IAAMM,mBAAmB,GAAG,SAAtBA,mBAAsB,GAAM;AACvCjC,EAAAA,gBAAgB;AAChB,mBAAUgC,6BAAcE,SAAd,GAA0BC,GAApC,2BACEH,6BAAcE,SAAd,GAA0BE,MAD5B,2CAGEJ,6BAAcE,SAAd,GAA0BG,WAH5B,2BAIiBC,IAAI,KAAKN,6BAAcE,SAAd,GAA0BK,YAJpD;AAKD,CAPM;;;;AASA,IAAMC,mBAAmB,GAAG,SAAtBA,mBAAsB,GAAM;AACvCxC,EAAAA,gBAAgB;AAChB,mBAAUgC,6BAAcE,SAAd,GAA0BC,GAApC,4BACEH,6BAAcE,SAAd,GAA0BE,MAD5B,2CAGEJ,6BAAcE,SAAd,GAA0BG,WAH5B,2BAIiBC,IAAI,KAAKN,6BAAcE,SAAd,GAA0BK,YAJpD;AAKD,CAPM;;;;AASA,IAAME,oBAAoB,GAAG,SAAvBA,oBAAuB,GAAM;AACxCzC,EAAAA,gBAAgB;AAChB,mBAAUgC,6BAAcE,SAAd,GAA0BC,GAApC,+BACEH,6BAAcE,SAAd,GAA0BG,WAD5B,yBAEeC,IAAI,KAAKN,6BAAcE,SAAd,GAA0BQ,WAFlD;AAGD,CALM;;;;AAOP,IAAM1C,gBAAgB,GAAG,SAAnBA,gBAAmB,GAAM;AAC7B,MAAIgC,6BAAcW,YAAd,EAAJ,EAAkC;AAClC,QAAMC,KAAK,CAAC,iCAAD,CAAX;AACD,CAHD;;AAKA,IAAMN,IAAI,GAAG,SAAPA,IAAO,GAAM;AACjB,MAAMO,cAAc,GAAGlC,MAAM,CAACC,QAAP,CAAgBC,IAAhB,CAAqBiC,KAArB,CAA2B,GAA3B,CAAvB;AACA,SAAOD,cAAc,CAAC,CAAD,CAAd,GAAoB,IAApB,GAA2BA,cAAc,CAAC,CAAD,CAAhD;AACD,CAHD;;AAKA,IAAME,iBAAiB,GAAG,SAApBA,iBAAoB,GAAM;AAC9B,MAAMC,YAAY,GAAGhB,6BAClBE,SADkB,GAElBC,GAFkB,CAEdc,OAFc,CAEN,UAFM,EAEM,EAFN,EAGlBA,OAHkB,CAGV,SAHU,EAGC,EAHD,CAArB;;AAIA,MAAMC,IAAI,GAAG,IAAIC,8BAAJ,CAAgB;AAC3BC,IAAAA,UAAU,EAAEpB,6BAAcE,SAAd,GAA0BmB,UADX;AAE3BC,IAAAA,QAAQ,EAAEtB,6BAAcE,SAAd,GAA0BG,WAFT;AAG3BkB,IAAAA,YAAY,EAAEP,YAHa;AAI3BQ,IAAAA,gBAAgB,EAAExB,6BAAcE,SAAd,GAA0BE,MAA1B,CAAiCU,KAAjC,CAAuC,GAAvC,CAJS;AAK3BW,IAAAA,iBAAiB,EAAEnB,IAAI,KAAKN,6BAAcE,SAAd,GAA0BK,YAL3B;AAM3BmB,IAAAA,kBAAkB,EAAEpB,IAAI,KAAKN,6BAAcE,SAAd,GAA0BQ;AAN5B,GAAhB,CAAb;AAQA,SAAOQ,IAAP;AACD,CAdD;;AAgBA,IAAMS,iBAAiB,GAAG,SAApBA,iBAAoB,GAAM;AAC9B,MAAMC,IAAI,GAAG,IAAIC,wCAAJ,CAAoB;AAC/BT,IAAAA,UAAU,EAAEpB,6BAAcE,SAAd,GAA0BmB,UADP;AAE/BC,IAAAA,QAAQ,EAAEtB,6BAAcE,SAAd,GAA0BG;AAFL,GAApB,CAAb;AAIA,SAAOuB,IAAI,CAACE,cAAL,EAAP;AACD,CAND;;AAQA,IAAMpD,uBAAuB,GAAG,SAA1BA,uBAA0B,CAACqD,eAAD,EAAqB;AACnD;AACA,SAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,QAAMhB,IAAI,GAAGH,iBAAiB,EAA9B;AAEAG,IAAAA,IAAI,CAACiB,WAAL,GAAmB;AACjBC,MAAAA,SAAS,EAAE,mBAAUrD,OAAV,EAAmB;AAC5BkD,QAAAA,OAAO,CAAClD,OAAD,CAAP;AACD,OAHgB;AAIjBsD,MAAAA,SAAS,EAAE,mBAAUjD,CAAV,EAAa;AACtB8C,QAAAA,MAAM,CAAC,IAAItB,KAAJ,CAAU,mCAAmCxB,CAA7C,CAAD,CAAN;AACD;AANgB,KAAnB;AAQA8B,IAAAA,IAAI,CAACoB,uBAAL,CAA6BP,eAA7B;AACD,GAZM,CAAP;AAaD,CAfD;;AAiBA,IAAMjC,UAAU,GAAG,SAAbA,UAAa,GAAM;AACvB,SAAO,IAAIkC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,QAAMK,WAAW,GAAGZ,iBAAiB,EAArC;;AACA,QAAIY,WAAJ,EAAiB;AACfA,MAAAA,WAAW,CAACC,UAAZ,CAAuB,UAAClD,KAAD,EAAQP,OAAR,EAAoB;AACzC,YAAIO,KAAK,IAAI,CAACP,OAAd,EAAuB;AACrBmD,UAAAA,MAAM,CAAC,IAAItB,KAAJ,CAAU,sCAAsCtB,KAAhD,CAAD,CAAN;AACD;;AAED2C,QAAAA,OAAO,CAAChD,SAAS,CAACF,OAAD,CAAV,CAAP;AACD,OAND;AAOD,KARD,MAQO;AACLmD,MAAAA,MAAM,CAAC,oBAAD,CAAN;AACD;AACF,GAbM,CAAP;AAcD,CAfD;;AAiBA,IAAMjD,SAAS,GAAG,SAAZA,SAAY,CAACF,OAAD,EAAa;AAC7B,MAAM0D,OAAO,aAAMzC,6BAAcE,SAAd,GAA0BC,GAAhC,cACXH,6BAAcE,SAAd,GAA0BmB,UADf,CAAb;AAGA,MAAMqB,WAAW,GAAG,IAAIC,kCAAJ,CAA+B;AACjDC,IAAAA,MAAM,sBACHH,OADG,EACO1D,OAAO,CAACG,OAAR,CAAgBC,QADvB;AAD2C,GAA/B,CAApB;AAMA,MAAIY,EAAE,GAAG,EAAT;;AACA,OAAK,IAAM8C,IAAX,IAAmB9D,OAAO,CAACG,OAAR,CAAgB4D,OAAnC,EAA4C;AAC1C/C,IAAAA,EAAE,CAAC8C,IAAD,CAAF,GAAW9D,OAAO,CAACG,OAAR,CAAgB4D,OAAhB,CAAwBD,IAAxB,CAAX;AACD,GAb4B,CAc7B;;;AACA9C,EAAAA,EAAE,CAAC2C,WAAH,GAAiBA,WAAjB;AACA,SAAO3C,EAAP;AACD,CAjBD","sourcesContent":["import React, { useEffect, useState } from \"react\";\nimport { useGlobalContext } from \"./GlobalContext\";\nimport { CognitoAuth } from \"amazon-cognito-auth-js/dist/amazon-cognito-auth\";\nimport { CognitoUserPool } from \"amazon-cognito-identity-js\";\nimport { config as AWSConfig, CognitoIdentityCredentials } from \"aws-sdk\";\nimport {\n  setBearerTokenInCrafterClient,\n  clearBearerTokenInCrafterClient,\n} from \"./Spa\";\nimport { cognitoConfig, cognitoConfig as configuration } from \"./cognitoConfig\";\n\nexport function CognitoLoginCallback(props) {\n  ensureConfigured();\n  const [{ user }, update] = useGlobalContext();\n  const { onSuccessInclude, onFailureInclude, onLoadInclude } = props;\n  const [cognitoSession, setCognitoSession] = useState(null);\n  const [loading, setLoading] = useState(false);\n\n  useEffect(() => {\n    if (!user) {\n      setLoading(true);\n      parseCognitoCallbackUrl(window.location.href)\n        .then((session) => {\n          // console.debug(\"Parsed callback got cognitoSession\", session);\n          setCognitoSession(session);\n          const appUser = asAppUser(session);\n          update({ user: appUser });\n          setBearerTokenInCrafterClient(session.idToken.jwtToken);\n          setLoading(false);\n        })\n        .catch((e) => {\n          console.error(\"Failure parsing callback url\", e);\n          setLoading(false);\n        });\n    }\n  }, []);\n\n  if (loading) {\n    return onLoadInclude ? onLoadInclude : null;\n  } else {\n    if (cognitoSession) {\n      return onSuccessInclude ? onSuccessInclude : null;\n    } else {\n      return onFailureInclude ? onFailureInclude : null;\n    }\n  }\n}\n\nexport function CognitoLogoutCallback(props) {\n  ensureConfigured();\n  const [{ user }, update] = useGlobalContext();\n  const { onSuccessInclude, onFailureInclude, onLoadInclude } = props;\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(null);\n\n  useEffect(() => {\n    setLoading(true);\n    clearBearerTokenInCrafterClient();\n    update({ user: null });\n    setLoading(false);\n  }, [user, loading]);\n\n  if (loading) {\n    return onLoadInclude ? onLoadInclude : null;\n  } else {\n    if (error) {\n      console.error(\"Failure in CognitoLogoutCallback\", error);\n      return onFailureInclude ? onFailureInclude : null;\n    } else {\n      return onSuccessInclude ? onSuccessInclude : null;\n    }\n  }\n}\n\nexport function CognitoUserRequired(props) {\n  ensureConfigured();\n  const { children, fallback } = props;\n  const [cognitoSession, setCognitoSession] = useState(null);\n  const [{ user }, update] = useGlobalContext();\n  const [isLoggedIn, setIsLoggedIn] = useState(false);\n  useEffect(() => {\n    if (user) {\n      setIsLoggedIn(true);\n    } else {\n      getAppUser()\n        .then((cu) => {\n          update({ user: cu });\n          setBearerTokenInCrafterClient(session.idToken.jwtToken);\n          setIsLoggedIn(true);\n        })\n        .catch((e) => {\n          // console.debug(\"Did not locate user (\" + e + \")\");\n          setIsLoggedIn(false);\n        });\n    }\n  }, [user, configuration]);\n  return isLoggedIn ? children : fallback;\n}\n\nexport const getCognitoSignInUri = () => {\n  ensureConfigured();\n  return `${configuration.getConfig().url}/login?scopes=${\n    configuration.getConfig().scopes\n  }&response_type=code&client_id=${\n    configuration.getConfig().appClientId\n  }&redirect_uri=${base() + configuration.getConfig().callbackPath}`;\n};\n\nexport const getCognitoSignUpUri = () => {\n  ensureConfigured();\n  return `${configuration.getConfig().url}/signup?scopes=${\n    configuration.getConfig().scopes\n  }&response_type=code&client_id=${\n    configuration.getConfig().appClientId\n  }&redirect_uri=${base() + configuration.getConfig().callbackPath}`;\n};\n\nexport const getCognitoSignOutUri = () => {\n  ensureConfigured();\n  return `${configuration.getConfig().url}/logout?client_id=${\n    configuration.getConfig().appClientId\n  }&logout_uri=${base() + configuration.getConfig().signoutPath}`;\n};\n\nconst ensureConfigured = () => {\n  if (configuration.isConfigured()) return;\n  throw Error(\"Cognito settings not configured\");\n};\n\nconst base = () => {\n  const windowUrlParts = window.location.href.split(\"/\");\n  return windowUrlParts[0] + \"//\" + windowUrlParts[2];\n};\n\nconst createCognitoAuth = () => {\n  const appWebDomain = configuration\n    .getConfig()\n    .url.replace(\"https://\", \"\")\n    .replace(\"http://\", \"\");\n  const auth = new CognitoAuth({\n    UserPoolId: configuration.getConfig().userPoolId,\n    ClientId: configuration.getConfig().appClientId,\n    AppWebDomain: appWebDomain,\n    TokenScopesArray: configuration.getConfig().scopes.split(\"+\"),\n    RedirectUriSignIn: base() + configuration.getConfig().callbackPath,\n    RedirectUriSignOut: base() + configuration.getConfig().signoutPath,\n  });\n  return auth;\n};\n\nconst createCognitoUser = () => {\n  const pool = new CognitoUserPool({\n    UserPoolId: configuration.getConfig().userPoolId,\n    ClientId: configuration.getConfig().appClientId,\n  });\n  return pool.getCurrentUser();\n};\n\nconst parseCognitoCallbackUrl = (fullCallbackUrl) => {\n  // console.debug(\"Processing callback URL\", fullCallbackUrl);\n  return new Promise((resolve, reject) => {\n    const auth = createCognitoAuth();\n\n    auth.userhandler = {\n      onSuccess: function (session) {\n        resolve(session);\n      },\n      onFailure: function (e) {\n        reject(new Error(\"Failure parsing callback URL: \" + e));\n      },\n    };\n    auth.parseCognitoWebResponse(fullCallbackUrl);\n  });\n};\n\nconst getAppUser = () => {\n  return new Promise((resolve, reject) => {\n    const cognitoUser = createCognitoUser();\n    if (cognitoUser) {\n      cognitoUser.getSession((error, session) => {\n        if (error || !session) {\n          reject(new Error(\"Failure getting Cognito session: \" + error));\n        }\n\n        resolve(asAppUser(session));\n      });\n    } else {\n      reject(\"User not logged in\");\n    }\n  });\n};\n\nconst asAppUser = (session) => {\n  const poolUrl = `${configuration.getConfig().url}/${\n    configuration.getConfig().userPoolId\n  }`;\n  const credentials = new CognitoIdentityCredentials({\n    Logins: {\n      [poolUrl]: session.idToken.jwtToken,\n    },\n  });\n\n  let cu = {};\n  for (const prop in session.idToken.payload) {\n    cu[prop] = session.idToken.payload[prop];\n  }\n  // should we allow developer to do custom mapping?\n  cu.credentials = credentials;\n  return cu;\n};\n"],"file":"CognitoUserInfo.js"}