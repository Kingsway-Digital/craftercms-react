{"version":3,"sources":["src/CognitoUserInfo.js"],"names":["CognitoLoginCallback","props","ensureConfigured","user","update","onSuccessInclude","onFailureInclude","onLoadInclude","cognitoSession","setCognitoSession","loading","setLoading","parseCognitoCallbackUrl","window","location","href","then","session","cu","asCognitoUser","idToken","jwtToken","e","console","error","CognitoLogoutCallback","setError","CognitoUserRequired","children","getCognitoUser","configuration","getCognitoSignInUri","getConfig","url","scopes","appClientId","base","callbackPath","getCognitoSignUpUri","getCognitoSignOutUri","signoutPath","isConfigured","Error","windowUrlParts","split","createCognitoAuth","appWebDomain","replace","auth","CognitoAuth","UserPoolId","userPoolId","ClientId","AppWebDomain","TokenScopesArray","RedirectUriSignIn","RedirectUriSignOut","createCognitoUserPool","CognitoUserPool","createCognitoUser","pool","getCurrentUser","fullCallbackUrl","Promise","resolve","reject","userhandler","onSuccess","onFailure","parseCognitoWebResponse","cognitoUser","getSession","poolUrl","uesrPoolId","credentials","CognitoIdentityCredentials","Logins","id","payload","email","firstname","lastname"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from \"react\";\nimport { useGlobalContext } from \"./GlobalContext\";\nimport { CognitoAuth } from \"amazon-cognito-auth-js/dist/amazon-cognito-auth\";\nimport { CognitoUserPool } from \"amazon-cognito-identity-js\";\nimport { config as AWSConfig, CognitoIdentityCredentials } from \"aws-sdk\";\nimport {\n  setBearerTokenInCrafterClient,\n  clearBearerTokenInCrafterClient,\n} from \"./Spa\";\nimport { cognitoConfig, cognitoConfig as configuration } from \"./cognitoConfig\";\n\nexport function CognitoLoginCallback(props) {\n  ensureConfigured();\n  const [{ user }, update] = useGlobalContext();\n  const { onSuccessInclude, onFailureInclude, onLoadInclude } = props;\n  const [cognitoSession, setCognitoSession] = useState(null);\n  const [loading, setLoading] = useState(false);\n\n  useEffect(() => {\n    if (!user) {\n      setLoading(true);\n      parseCognitoCallbackUrl(window.location.href)\n        .then((session) => {\n          // console.debug(\"Parsed callback got cognitoSession\", session);\n          setCognitoSession(session);\n          const cu = asCognitoUser(session);\n          update({ user: cu });\n          setBearerTokenInCrafterClient(session.idToken.jwtToken);\n          setLoading(false);\n        })\n        .catch((e) => {\n          console.error(\"Failure parsing callback url\", e);\n          setLoading(false);\n        });\n    }\n  }, []);\n\n  if (loading) {\n    return onLoadInclude ? onLoadInclude : \"\";\n  } else {\n    if (cognitoSession) {\n      return onSuccessInclude;\n    } else {\n      return onFailureInclude;\n    }\n  }\n}\n\nexport function CognitoLogoutCallback(props) {\n  ensureConfigured();\n  const [{ user }, update] = useGlobalContext();\n  const { onSuccessInclude, onFailureInclude, onLoadInclude } = props;\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(null);\n\n  useEffect(() => {\n    setLoading(true);\n    clearBearerTokenInCrafterClient();\n    update({ user: null });\n    setLoading(false);\n  }, [user, loading]);\n\n  if (loading) {\n    return onLoadInclude ? onLoadInclude : \"\";\n  } else {\n    if (error) {\n      console.error(\"Failure in CognitoLogoutCallback\", error);\n      return onFailureInclude;\n    } else {\n      return onSuccessInclude;\n    }\n  }\n}\n\nexport function CognitoUserRequired(props) {\n  ensureConfigured();\n  const { children } = props;\n  const [cognitoSession, setCognitoSession] = useState(null);\n  const [{ user }, update] = useGlobalContext();\n  useEffect(() => {\n    if (!user) {\n      getCognitoUser()\n        .then((cu) => {\n          update({ user: cu });\n          setBearerTokenInCrafterClient(session.idToken.jwtToken);\n        })\n        .catch((e) => {\n          console.error(\"Failed to locate user: \" + e);\n        });\n    }\n  }, [user, configuration]);\n  return user ? children : null;\n}\n\nexport const getCognitoSignInUri = () => {\n  ensureConfigured();\n  return `${configuration.getConfig().url}/login?scopes=${\n    configuration.getConfig().scopes\n  }&response_type=code&client_id=${\n    configuration.getConfig().appClientId\n  }&redirect_uri=${base() + configuration.getConfig().callbackPath}`;\n};\n\nexport const getCognitoSignUpUri = () => {\n  ensureConfigured();\n  return `${configuration.getConfig().url}/signup?scopes=${\n    configuration.getConfig().scopes\n  }&response_type=code&client_id=${\n    configuration.getConfig().appClientId\n  }&redirect_uri=${base() + configuration.getConfig().callbackPath}`;\n};\n\nexport const getCognitoSignOutUri = () => {\n  ensureConfigured();\n  return `${configuration.getConfig().url}/logout?client_id=${\n    configuration.getConfig().appClientId\n  }&logout_uri=${base() + configuration.getConfig().signoutPath}`;\n};\n\nconst ensureConfigured = () => {\n  if (configuration.isConfigured()) return;\n  throw Error(\"Cognito settings not configured\");\n};\n\nconst base = () => {\n  const windowUrlParts = window.location.href.split(\"/\");\n  return windowUrlParts[0] + \"//\" + windowUrlParts[2];\n};\n\nconst createCognitoAuth = () => {\n  const appWebDomain = configuration\n    .getConfig()\n    .url.replace(\"https://\", \"\")\n    .replace(\"http://\", \"\");\n  const auth = new CognitoAuth({\n    UserPoolId: configuration.getConfig().userPoolId,\n    ClientId: configuration.getConfig().appClientId,\n    AppWebDomain: appWebDomain,\n    TokenScopesArray: configuration.getConfig().scopes.split(\"+\"),\n    RedirectUriSignIn: base() + configuration.getConfig().callbackPath,\n    RedirectUriSignOut: base() + configuration.getConfig().signoutPath,\n  });\n  return auth;\n};\n\nconst createCognitoUserPool = () =>\n  new CognitoUserPool({\n    UserPoolId: configuration.getConfig().userPoolId,\n    ClientId: configuration.getConfig().appClientId,\n  });\n\nconst createCognitoUser = () => {\n  const pool = createCognitoUserPool();\n  return pool.getCurrentUser();\n};\n\nconst parseCognitoCallbackUrl = (fullCallbackUrl) => {\n  // console.debug(\"Processing callback URL\", fullCallbackUrl);\n  return new Promise((resolve, reject) => {\n    const auth = createCognitoAuth();\n\n    auth.userhandler = {\n      onSuccess: function (session) {\n        resolve(session);\n      },\n      onFailure: function (e) {\n        reject(new Error(\"Failure parsing callback URL: \" + e));\n      },\n    };\n    auth.parseCognitoWebResponse(fullCallbackUrl);\n  });\n};\n\nconst getCognitoUser = () => {\n  return new Promise((resolve, reject) => {\n    const cognitoUser = createCognitoUser();\n    cognitoUser.getSession((error, session) => {\n      if (error || !session) {\n        reject(new Error(\"Failure getting Cognito session: \" + error));\n        return null;\n      }\n\n      // console.debug(\"Retrieved user session:\", session);\n      resolve(asCognitoUser(session));\n    });\n  });\n};\n\nconst asCognitoUser = (session) => {\n  const poolUrl = `${configuration.getConfig().url}/${\n    configuration.getConfig().uesrPoolId\n  }`;\n  const credentials = new CognitoIdentityCredentials({\n    Logins: {\n      [poolUrl]: session.idToken.jwtToken,\n    },\n  });\n\n  const cu = {};\n  cu.id = session.idToken.payload[\"cognito:username\"];\n  cu.email = session.idToken.payload.email;\n  cu.firstname = session.idToken.payload[\"given_name\"];\n  cu.lastname = session.idToken.payload[\"family_name\"];\n  cu.credentials = credentials;\n  return cu;\n};\n"],"file":"CognitoUserInfo.js"}